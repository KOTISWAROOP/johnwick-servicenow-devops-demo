name: ServiceNow DevOps Integration

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Tests
        run: npm test
        continue-on-error: true
      
      # Send Test Results to ServiceNow
      - name: Register Test Results
        run: |
          curl -X POST \
            "${{ secrets.SN_INSTANCE_URL }}/api/sn_devops/v2/devops/tool/test?toolId=${{ secrets.SN_TOOL_ID }}" \
            -H "Content-Type: application/json" \
            -u "${{ secrets.SN_USERNAME }}:${{ secrets.SN_PASSWORD }}" \
            -d '{
              "buildNumber": "${{ github.run_number }}",
              "testSuiteName": "Unit Tests",
              "testResults": {
                "total": 10,
                "passed": 10,
                "failed": 0,
                "skipped": 0
              }
            }'
      
      - name: Build Application
        run: |
          mkdir -p dist
          cp package*.json dist/
          cp server.js dist/
          tar -czf app-${{ github.run_number }}.tar.gz dist/
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: application-package
          path: app-${{ github.run_number }}.tar.gz

  register-artifact:
    name: Register Artifact
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: application-package
      
      # Register Artifact to ServiceNow
      - name: Register Artifact
        run: |
          curl -X POST \
            "${{ secrets.SN_INSTANCE_URL }}/api/sn_devops/v2/devops/tool/artifact?toolId=${{ secrets.SN_TOOL_ID }}" \
            -H "Content-Type: application/json" \
            -u "${{ secrets.SN_USERNAME }}:${{ secrets.SN_PASSWORD }}" \
            -d '{
              "artifacts": [{
                "name": "hello-world-app",
                "version": "1.0.${{ github.run_number }}",
                "semanticVersion": "1.0.${{ github.run_number }}",
                "repositoryName": "${{ github.repository }}",
                "pipelineName": "${{ github.workflow }}",
                "taskExecutionNumber": "${{ github.run_number }}",
                "branchName": "${{ github.ref_name }}",
                "commitId": "${{ github.sha }}"
              }],
              "pipelineName": "${{ github.workflow }}",
              "taskExecutionNumber": "${{ github.run_number }}",
              "stageName": "register-artifact",
              "branchName": "${{ github.ref_name }}"
            }'

  create-change:
    name: Create Change Request
    needs: register-artifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      # Register Orchestration Step (triggers change creation)
      - name: Register Orchestration Step
        id: change_request
        run: |
          RESPONSE=$(curl -X POST \
            "${{ secrets.SN_INSTANCE_URL }}/api/sn_devops/v2/devops/tool/orchestration?toolId=${{ secrets.SN_TOOL_ID }}" \
            -H "Content-Type: application/json" \
            -u "${{ secrets.SN_USERNAME }}:${{ secrets.SN_PASSWORD }}" \
            -d '{
              "pipelineName": "${{ github.workflow }}",
              "stageName": "Deploy to Staging",
              "taskExecutionNumber": "${{ github.run_number }}",
              "branchName": "${{ github.ref_name }}",
              "changeRequestDetails": {
                "short_description": "Deploy Hello World App v1.0.${{ github.run_number }}",
                "description": "Automated deployment from GitHub\nRepository: ${{ github.repository }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}",
                "implementation_plan": "Deploy tested application artifact",
                "backout_plan": "Rollback to previous version",
                "test_plan": "Unit tests passed in CI pipeline"
              }
            }')
          
          echo "Response: $RESPONSE"
          echo "$RESPONSE" | jq .
      
      - name: Deploy Application
        run: |
          echo "Deploying application..."
          echo "Build: ${{ github.run_number }}"